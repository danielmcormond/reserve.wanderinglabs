InitialImport::ReserveAmerica::Agencies.import
InitialImport::ReserveAmerica::Base.import


Facility::ReserveAmerica.where('created_at > ?', 1.hour.ago).all.each do |facility|
  InitialImport::ReserveAmerica::Sites.new(facility).import
end

ActiveRecord::Base.logger.level = 1

Facility::ReserveAmerica.where(sites_count: 0).each_with_index do |facility, x|
  puts "#{x} Facility: #{facility.id} - #{facility.name}"
  begin
    InitialImport::ReserveAmerica::Sites.new(facility).import
  rescue
    puts "RESCUED.................."
    facility.update_attributes(status: :requires_attention)
  end
end


Facility::ReserveAmerica.where('sites_count > 0').where(booking_window: nil).each_with_index do |facility, x|
  puts "#{x} Facility: #{facility.id} - #{facility.name}"
  begin
    InitialImport::ReserveAmerica::BookingWindow.new(facility).find
  rescue
    puts "RESCUED.................."
    facility.update_attributes(status: :requires_attention)
  end
end


InitialImport::ReserveAmerica::Facilities.new(agency).all_facilities

------

Grayton beach updates

f=Facility::ReserveAmerica.find 3526

current = f.availability_requests.active.where('specific_site_ids is not null').all.map { |ar| [ar.id, ar.specific_site_ids, Site.where(id: ar.specific_site_ids).all.map { |s| [s.id, s.ext_site_id, s.site_num] }] }

> current.to_json
"[[166530,[103664,103660,103658,103656,103654],[[103654,\"16\",\"014\"],[103656,\"18\",\"016\"],[103658,\"20\",\"018\"],[103660,\"22\",\"020\"],[103664,\"26\",\"024\"]]],[107970,[103660,103685],[[103660,\"22\",\"020\"],[103685,\"4858\",\"047\"]]],[134643,[103687],[[103687,\"4860\",\"049\"]]],[171031,[103651,103653,103654,103656,103658,103660],[[103651,\"12\",\"010\"],[103653,\"14\",\"012\"],[103654,\"16\",\"014\"],[103656,\"18\",\"016\"],[103658,\"20\",\"018\"],[103660,\"22\",\"020\"]]],[119564,[103656],[[103656,\"18\",\"016\"]]],[134978,[103656,103658,103662],[[103656,\"18\",\"016\"],[103658,\"20\",\"018\"],[103662,\"24\",\"022\"]]],[170352,[103660,103658,103662,103664,103656],[[103656,\"18\",\"016\"],[103658,\"20\",\"018\"],[103660,\"22\",\"020\"],[103662,\"24\",\"022\"],[103664,\"26\",\"024\"]]],[140152,[103656,103658,103660,103662,103664,103667,103669],[[103656,\"18\",\"016\"],[103658,\"20\",\"018\"],[103660,\"22\",\"020\"],[103662,\"24\",\"022\"],[103664,\"26\",\"024\"],[103667,\"30\",\"028\"],[103669,\"32\",\"030\"]]],[149697,[103653,103654,103656,103658,103660],[[103653,\"14\",\"012\"],[103654,\"16\",\"014\"],[103656,\"18\",\"016\"],[103658,\"20\",\"018\"],[103660,\"22\",\"020\"]]],[125509,[103649,103651,103653,103654,103656,103658,103660,103662,103664,103667,103678,103679,103680,103682,103684,103686],[[103649,\"10\",\"008\"],[103651,\"12\",\"010\"],[103653,\"14\",\"012\"],[103654,\"16\",\"014\"],[103656,\"18\",\"016\"],[103658,\"20\",\"018\"],[103660,\"22\",\"020\"],[103662,\"24\",\"022\"],[103664,\"26\",\"024\"],[103667,\"30\",\"028\"],[103678,\"4852\",\"040\"],[103679,\"4853\",\"041\"],[103680,\"4854\",\"042\"],[103682,\"4856\",\"044\"],[103684,\"4857\",\"046\"],[103686,\"4859\",\"048\"]]],[100794,[103649,103651,103653,103654,103656,103658,103660,103662,103664],[[103649,\"10\",\"008\"],[103651,\"12\",\"010\"],[103653,\"14\",\"012\"],[103654,\"16\",\"014\"],[103656,\"18\",\"016\"],[103658,\"20\",\"018\"],[103660,\"22\",\"020\"],[103662,\"24\",\"022\"],[103664,\"26\",\"024\"]]],[157631,[103654,103656,103658,103660,103662,103664],[[103654,\"16\",\"014\"],[103656,\"18\",\"016\"],[103658,\"20\",\"018\"],[103660,\"22\",\"020\"],[103662,\"24\",\"022\"],[103664,\"26\",\"024\"]]],[164420,[103685,103688],[[103685,\"4858\",\"047\"],[103688,\"4861\",\"050\"]]],[159942,[103664],[[103664,\"26\",\"024\"]]],[168926,[102973,102975,102977,102979,102981,102983],[[102973,\"412\",\"014\"],[102975,\"414\",\"016\"],[102977,\"416\",\"018\"],[102979,\"418\",\"020\"],[102981,\"420\",\"022\"],[102983,\"422\",\"024\"]]],[172452,[103654,103656,103658,103660,103662,103664],[[103654,\"16\",\"014\"],[103656,\"18\",\"016\"],[103658,\"20\",\"018\"],[103660,\"22\",\"020\"],[103662,\"24\",\"022\"],[103664,\"26\",\"024\"]]],[169673,[103649,103650,103651,103652,103653,103654,103655,103656,103657,103658,103659,103660,103661,103662,103663,103664,103665,103666,103667],[[103649,\"10\",\"008\"],[103650,\"11\",\"009\"],[103651,\"12\",\"010\"],[103652,\"13\",\"011\"],[103653,\"14\",\"012\"],[103654,\"16\",\"014\"],[103655,\"17\",\"015\"],[103656,\"18\",\"016\"],[103657,\"19\",\"017\"],[103658,\"20\",\"018\"],[103659,\"21\",\"019\"],[103660,\"22\",\"020\"],[103661,\"23\",\"021\"],[103662,\"24\",\"022\"],[103663,\"25\",\"023\"],[103664,\"26\",\"024\"],[103665,\"27\",\"025\"],[103666,\"29\",\"027\"],[103667,\"30\",\"028\"]]]]"

InitialImport::ReserveAmerica::Sites.new(f).import

irb(main):007:0> f.sites.where('updated_at < ?', 1.hour.ago).map(&:id)
[
    [0] 103648,
    [1] 103650,
    [2] 103696,
    [3] 103697
]


current.each do |c|
  a = AvailabilityRequest.find(c[0])
  id_from = a.specific_site_ids
  id_to = f.sites.where(site_num: c[2].map(&:third)).map(&:id)
  puts "#{a.id} #{id_from.size}/#{id_to.size} :: #{id_from.join(",")} - #{id_to.join(",")}"
  a.update(specific_site_ids: id_to)
end; nil
